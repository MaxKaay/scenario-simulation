<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquidity Position Simulator</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        input[type="number"], input[type="text"], textarea {
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
        }
    </style>
</head>
<body>
    <h2>Liquidity Position Simulator</h2>
    <textarea id="multiRowInput" placeholder="Paste multiple rows here..."></textarea>
    <button onclick="parseAndSimulateRows()">Simulate Multiple Rows</button>
    <table>
        <thead>
            <tr>
                <th>precedingAction</th>
                <th>currentTick</th>
                <th>floorTickLower</th>
                <th>floorTickUpper</th>
                <th>floorEth</th>
                <th>floorHarb</th>
                <th>anchorTickLower</th>
                <th>anchorTickUpper</th>
                <th>anchorEth</th>
                <th>anchorHarb</th>
                <th>discoveryTickLower</th>
                <th>discoveryTickUpper</th>
                <th>discoveryEth</th>
                <th>discoveryHarb</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" id="precedingAction" oninput="parseRow()"></td>
                <td><input type="number" id="currentTick"></td>
                <td><input type="number" id="floorTickLower"></td>
                <td><input type="number" id="floorTickUpper"></td>
                <td><input type="number" id="floorEth"></td>
                <td><input type="number" id="floorHarb"></td>
                <td><input type="number" id="anchorTickLower"></td>
                <td><input type="number" id="anchorTickUpper"></td>
                <td><input type="number" id="anchorEth"></td>
                <td><input type="number" id="anchorHarb"></td>
                <td><input type="number" id="discoveryTickLower"></td>
                <td><input type="number" id="discoveryTickUpper"></td>
                <td><input type="number" id="discoveryEth"></td>
                <td><input type="number" id="discoveryHarb"></td>
                <td><button onclick="simulateSingleRow()">Simulate Single Row</button></td>
            </tr>
        </tbody>
    </table>
    <div id="simulations"></div>

    <script>
        function parseRow() {
            const input = document.getElementById('precedingAction').value;
            const values = input.split('\t');
            if (values.length >= 14) {
                document.getElementById('precedingAction').value = values[0];
                document.getElementById('currentTick').value = parseFloat(values[1]);
                document.getElementById('floorTickLower').value = parseFloat(values[2]);
                document.getElementById('floorTickUpper').value = parseFloat(values[3]);
                document.getElementById('floorEth').value = parseFloat(values[4]) / 1e18;
                document.getElementById('floorHarb').value = parseFloat(values[5]) / 1e18;
                document.getElementById('anchorTickLower').value = parseFloat(values[6]);
                document.getElementById('anchorTickUpper').value = parseFloat(values[7]);
                document.getElementById('anchorEth').value = parseFloat(values[8]) / 1e18;
                document.getElementById('anchorHarb').value = parseFloat(values[9]) / 1e18;
                document.getElementById('discoveryTickLower').value = parseFloat(values[10]);
                document.getElementById('discoveryTickUpper').value = parseFloat(values[11]);
                document.getElementById('discoveryEth').value = parseFloat(values[12]) / 1e18;
                document.getElementById('discoveryHarb').value = parseFloat(values[13]) / 1e18;
            }
        }

        function parseAndSimulateRows() {
            const input = document.getElementById('multiRowInput').value.trim();
            const rows = input.split('\n');
            rows.forEach(row => {
                const values = row.split('\t');
                if (values.length >= 14) {
                    const precedingAction = values[0];
                    const currentTick = parseFloat(values[1]);
                    const floorTickLower = parseFloat(values[2]);
                    const floorTickUpper = parseFloat(values[3]);
                    const floorEth = parseFloat(values[4]) / 1e18;
                    const floorHarb = parseFloat(values[5]) / 1e18;
                    const anchorTickLower = parseFloat(values[6]);
                    const anchorTickUpper = parseFloat(values[7]);
                    const anchorEth = parseFloat(values[8]) / 1e18;
                    const anchorHarb = parseFloat(values[9]) / 1e18;
                    const discoveryTickLower = parseFloat(values[10]);
                    const discoveryTickUpper = parseFloat(values[11]);
                    const discoveryEth = parseFloat(values[12]) / 1e18;
                    const discoveryHarb = parseFloat(values[13]) / 1e18;

                    simulate(precedingAction, currentTick, floorTickLower, floorTickUpper, floorEth, floorHarb, anchorTickLower, anchorTickUpper, anchorEth, anchorHarb, discoveryTickLower, discoveryTickUpper, discoveryEth, discoveryHarb);
                }
            });

            // Clear input field after processing
            document.getElementById('multiRowInput').value = '';
        }

        function simulateSingleRow() {
            const precedingAction = document.getElementById('precedingAction').value;
            const currentTick = parseFloat(document.getElementById('currentTick').value);
            const floorTickLower = parseFloat(document.getElementById('floorTickLower').value);
            const floorTickUpper = parseFloat(document.getElementById('floorTickUpper').value);
            const floorEth = parseFloat(document.getElementById('floorEth').value);
            const floorHarb = parseFloat(document.getElementById('floorHarb').value);
            const anchorTickLower = parseFloat(document.getElementById('anchorTickLower').value);
            const anchorTickUpper = parseFloat(document.getElementById('anchorTickUpper').value);
            const anchorEth = parseFloat(document.getElementById('anchorEth').value);
            const anchorHarb = parseFloat(document.getElementById('anchorHarb').value);
            const discoveryTickLower = parseFloat(document.getElementById('discoveryTickLower').value);
            const discoveryTickUpper = parseFloat(document.getElementById('discoveryTickUpper').value);
            const discoveryEth = parseFloat(document.getElementById('discoveryEth').value);
            const discoveryHarb = parseFloat(document.getElementById('discoveryHarb').value);

            simulate(precedingAction, currentTick, floorTickLower, floorTickUpper, floorEth, floorHarb, anchorTickLower, anchorTickUpper, anchorEth, anchorHarb, discoveryTickLower, discoveryTickUpper, discoveryEth, discoveryHarb);

            // Clear input fields after processing
            document.getElementById('precedingAction').value = '';
            document.getElementById('currentTick').value = '';
            document.getElementById('floorTickLower').value = '';
            document.getElementById('floorTickUpper').value = '';
            document.getElementById('floorEth').value = '';
            document.getElementById('floorHarb').value = '';
            document.getElementById('anchorTickLower').value = '';
            document.getElementById('anchorTickUpper').value = '';
            document.getElementById('anchorEth').value = '';
            document.getElementById('anchorHarb').value = '';
            document.getElementById('discoveryTickLower').value = '';
            document.getElementById('discoveryTickUpper').value = '';
            document.getElementById('discoveryEth').value = '';
            document.getElementById('discoveryHarb').value = '';
        }

        function simulate(precedingAction, currentTick, floorTickLower, floorTickUpper, floorEth, floorHarb, anchorTickLower, anchorTickUpper, anchorEth, anchorHarb, discoveryTickLower, discoveryTickUpper, discoveryEth, discoveryHarb) {
            // Calculate bar widths based on tick ranges
            var tick_starts = [discoveryTickLower, anchorTickLower, floorTickLower];
            var tick_ends = [discoveryTickUpper, anchorTickUpper, floorTickUpper];
            var liquidity = [
                discoveryEth + discoveryHarb,
                anchorEth + anchorHarb,
                floorEth + floorHarb
            ];
            var eth = [discoveryEth, anchorEth, floorEth];
            var harb = [discoveryHarb, anchorHarb, floorHarb];

            var widths = tick_ends.map((end, i) => end - tick_starts[i]);

            var data = [
                {
                    x: tick_starts.map((start, i) => start + widths[i] / 2),
                    y: harb,
                    width: widths,
                    type: 'bar',
                    marker: {
                        color: ['green', 'red', 'blue'],
                        opacity: 0.6
                    },
                    text: harb.map((h, i) => `ETH: ${eth[i].toFixed(18)}<br>HARB: ${h.toFixed(18)}`),
                    hoverinfo: 'text',
                    name: 'Liquidity'
                }
            ];

            var layout = {
                title: `Liquidity, ETH, and HARB Distribution - ${precedingAction}`,
                xaxis: {
                    title: 'Ticks',
                    tickvals: tick_starts.concat([currentTick], tick_ends),
                    ticktext: tick_starts.map(String).concat([`${currentTick}\n(Current Price)`], tick_ends.map(String))
                },
                yaxis: {
                    title: 'Liquidity (HARB)'
                },
                shapes: [
                    {
                        type: 'line',
                        x0: currentTick,
                        x1: currentTick,
                        y0: 0,
                        y1: Math.max(...liquidity) * 1.1,
                        line: {
                            color: 'black',
                            width: 2,
                            dash: 'dash'
                        },
                        name: 'Current Tick'
                    }
                ]
            };

            var newDiv = document.createElement('div');
            newDiv.style.marginBottom = '20px';
            var newHeader = document.createElement('h3');
            newHeader.textContent = `Liquidity, ETH, and HARB Distribution - ${precedingAction}`;
            var newChart = document.createElement('div');
            newChart.style.width = '100%';
            newChart.style.height = '600px';
            var toggleButton = document.createElement('button');
            toggleButton.textContent = 'Toggle ETH/HARB';
            toggleButton.setAttribute('data-isethdisplayed', 'false');
            toggleButton.onclick = function() { toggleData(newChart, eth, harb, tick_starts, widths, currentTick, precedingAction, toggleButton); };
            newDiv.appendChild(newHeader);
            newDiv.appendChild(toggleButton);
            newDiv.appendChild(newChart);
            document.getElementById('simulations').appendChild(newDiv);

            Plotly.newPlot(newChart, data, layout);
        }

        function toggleData(chart, eth, harb, tick_starts, widths, currentTick, precedingAction, button) {
            var isETHDisplayed = button.getAttribute('data-isethdisplayed') === 'true';
            var currentData = isETHDisplayed ? harb : eth;
            var textData = isETHDisplayed ? eth : harb;
            var data = [
                {
                    x: tick_starts.map((start, i) => start + widths[i] / 2),
                    y: currentData,
                    width: widths,
                    type: 'bar',
                    marker: {
                        color: ['green', 'red', 'blue'],
                        opacity: 0.6
                    },
                    text: textData.map((value, i) => `ETH: ${eth[i].toFixed(18)}<br>HARB: ${harb[i].toFixed(18)}`),
                    hoverinfo: 'text',
                    name: 'Liquidity'
                }
            ];

            var layout = {
                title: `Liquidity, ${isETHDisplayed ? 'ETH' : 'HARB'}, and ${isETHDisplayed ? 'HARB' : 'ETH'} Distribution - ${precedingAction}`,
                xaxis: {
                    title: 'Ticks',
                    tickvals: tick_starts.concat([currentTick], tick_ends),
                    ticktext: tick_starts.map(String).concat([`${currentTick}\n(Current Price)`], tick_ends.map(String))
                },
                yaxis: {
                    title: `Liquidity (${isETHDisplayed ? 'ETH' : 'HARB'})`
                },
                shapes: [
                    {
                        type: 'line',
                        x0: currentTick,
                        x1: currentTick,
                        y0: 0,
                        y1: Math.max(...currentData) * 1.1,
                        line: {
                            color: 'black',
                            width: 2,
                            dash: 'dash'
                        },
                        name: 'Current Tick'
                    }
                ]
            };

            button.setAttribute('data-isethdisplayed', (!isETHDisplayed).toString());
            Plotly.newPlot(chart, data, layout);
        }
    </script>
</body>
</html>
