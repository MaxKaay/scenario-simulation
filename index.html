<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquidity Position Simulator</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        input[type="number"], input[type="text"] {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h2>Liquidity Position Simulator</h2>
    <table>
        <thead>
            <tr>
                <th>precedingAction</th>
                <th>currentTick</th>
                <th>floorTickLower</th>
                <th>floorTickUpper</th>
                <th>floorEth</th>
                <th>floorHarb</th>
                <th>anchorTickLower</th>
                <th>anchorTickUpper</th>
                <th>anchorEth</th>
                <th>anchorHarb</th>
                <th>discoveryTickLower</th>
                <th>discoveryTickUpper</th>
                <th>discoveryEth</th>
                <th>discoveryHarb</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" id="precedingAction" oninput="parseRow()"></td>
                <td><input type="number" id="currentTick"></td>
                <td><input type="number" id="floorTickLower"></td>
                <td><input type="number" id="floorTickUpper"></td>
                <td><input type="number" id="floorEth"></td>
                <td><input type="number" id="floorHarb"></td>
                <td><input type="number" id="anchorTickLower"></td>
                <td><input type="number" id="anchorTickUpper"></td>
                <td><input type="number" id="anchorEth"></td>
                <td><input type="number" id="anchorHarb"></td>
                <td><input type="number" id="discoveryTickLower"></td>
                <td><input type="number" id="discoveryTickUpper"></td>
                <td><input type="number" id="discoveryEth"></td>
                <td><input type="number" id="discoveryHarb"></td>
                <td><button onclick="simulate()">Simulate</button></td>
            </tr>
        </tbody>
    </table>
    <div id="chart" style="width:100%;height:600px;"></div>

    <script>
        function parseRow() {
            const input = document.getElementById('precedingAction').value;
            const values = input.split('\\t');
            if (values.length >= 14) {
                document.getElementById('precedingAction').value = values[0];
                document.getElementById('currentTick').value = parseFloat(values[1]);
                document.getElementById('floorTickLower').value = parseFloat(values[2]);
                document.getElementById('floorTickUpper').value = parseFloat(values[3]);
                document.getElementById('floorEth').value = parseFloat(values[4]);
                document.getElementById('floorHarb').value = parseFloat(values[5]);
                document.getElementById('anchorTickLower').value = parseFloat(values[6]);
                document.getElementById('anchorTickUpper').value = parseFloat(values[7]);
                document.getElementById('anchorEth').value = parseFloat(values[8]);
                document.getElementById('anchorHarb').value = parseFloat(values[9]);
                document.getElementById('discoveryTickLower').value = parseFloat(values[10]);
                document.getElementById('discoveryTickUpper').value = parseFloat(values[11]);
                document.getElementById('discoveryEth').value = parseFloat(values[12]);
                document.getElementById('discoveryHarb').value = parseFloat(values[13]);
            }
        }

        function simulate() {
            var precedingAction = document.getElementById('precedingAction').value;
            var currentTick = parseFloat(document.getElementById('currentTick').value);
            var floorTickLower = parseFloat(document.getElementById('floorTickLower').value);
            var floorTickUpper = parseFloat(document.getElementById('floorTickUpper').value);
            var floorEth = parseFloat(document.getElementById('floorEth').value);
            var floorHarb = parseFloat(document.getElementById('floorHarb').value);
            var anchorTickLower = parseFloat(document.getElementById('anchorTickLower').value);
            var anchorTickUpper = parseFloat(document.getElementById('anchorTickUpper').value);
            var anchorEth = parseFloat(document.getElementById('anchorEth').value);
            var anchorHarb = parseFloat(document.getElementById('anchorHarb').value);
            var discoveryTickLower = parseFloat(document.getElementById('discoveryTickLower').value);
            var discoveryTickUpper = parseFloat(document.getElementById('discoveryTickUpper').value);
            var discoveryEth = parseFloat(document.getElementById('discoveryEth').value);
            var discoveryHarb = parseFloat(document.getElementById('discoveryHarb').value);

            // Calculate bar widths based on tick ranges
            var tick_starts = [discoveryTickLower, anchorTickLower, floorTickLower];
            var tick_ends = [discoveryTickUpper, anchorTickUpper, floorTickUpper];
            var liquidity = [
                discoveryEth + discoveryHarb,
                anchorEth + anchorHarb,
                floorEth + floorHarb
            ];
            var eth = [discoveryEth, anchorEth, floorEth];
            var harb = [discoveryHarb, anchorHarb, floorHarb];

            var widths = tick_ends.map((end, i) => end - tick_starts[i]);

            var data = [
                {
                    x: tick_starts.map((start, i) => start + widths[i] / 2),
                    y: liquidity,
                    width: widths,
                    type: 'bar',
                    marker: {
                        color: ['green', 'red', 'blue'],
                        opacity: 0.6
                    },
                    text: eth.map((e, i) => `ETH: ${e.toFixed(18)}<br>HARB: ${harb[i].toFixed(18)}`),
                    hoverinfo: 'text',
                    name: 'Liquidity'
                }
            ];

            var layout = {
                title: `Liquidity, ETH, and HARB Distribution - ${precedingAction}`,
                xaxis: {
                    title: 'Ticks',
                    tickvals: tick_starts.concat([currentTick], tick_ends),
                    ticktext: tick_starts.map(String).concat([`${currentTick}\n(Current Price)`], tick_ends.map(String))
                },
                yaxis: {
                    title: 'Liquidity'
                },
                shapes: [
                    {
                        type: 'line',
                        x0: currentTick,
                        x1: currentTick,
                        y0: 0,
                        y1: Math.max(...liquidity) * 1.1,
                        line: {
                            color: 'black',
                            width: 2,
                            dash: 'dash'
                        },
                        name: 'Current Tick'
                    }
                ]
            };

            Plotly.newPlot('chart', data, layout);
        }
    </script>
</body>
</html>
